{% extends "baseTrader.html" %}

{% block content %}
{% include 'components/home/navigatorBase.html' %}

<style>
  #calendar {
    max-width: 100%;
    overflow-x: auto;
  }

  .fc .fc-toolbar-chunk button {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  .fc .fc-event {
    color: #fff;
    border-radius: 0.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  .fc .fc-toolbar-title {
    color: #293272;
    font-weight: 700;
    font-size: 1.125rem;
  }

  /* Tooltip styling */
  .fc-tooltip {
    position: absolute;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    pointer-events: none;
    white-space: nowrap;
  }

  /* Fix FullCalendar tooltip behind navbar or modal */
  .fc-popover,
  .fc-more-popover,
  .fc-popover.fc-more-popover,
  .fc-event-tooltip {
    z-index: 999999 !important;
    position: fixed !important;
  }

  /* Ensure itâ€™s visible above any container */
  .fc-popover-body,
  .fc-popover-header {
    position: relative !important;
    z-index: inherit !important;
  }
</style>

<main class="max-w-7xl mx-auto px-6 py-8 space-y-10 w-full">

  <!-- Dashboard Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- To Quote Requests -->
    <div class="border rounded-xl p-6 text-center shadow hover:shadow-md transition relative">
      <h2 class="font-bold text-[#293272] text-lg mb-2">
        <a href="{% url 'maintenance_request_list' %}">To Quote Requests</a>
      </h2>
      <a href="{% url 'maintenance_request_list' %}?priority=true">
        <p class="text-[#EF7153] text-sm hover:underline">{{ to_quote_urgent }} urgent</p>
      </a>
      <a href="{% url 'maintenance_request_list' %}?priority=false">
        <p class="text-[#EF7153] text-sm hover:underline">{{ to_quote_non_urgent }} non-urgent</p>
      </a>
    </div>

    <!-- Pending Quotes -->
    <div class="border rounded-xl p-6 text-center shadow hover:shadow-md transition relative">
      <a href="{% url 'quote_list' %}?status=pending">
        <h2 class="font-bold text-[#293272] text-lg mb-2">Pending Quotes</h2>
      </a>
      <a href="{% url 'quote_list' %}?status=pending&priority=true">
        <p class="text-[#EF7153] text-sm hover:underline">{{ pending_urgent }} urgent</p>
      </a>
      <a href="{% url 'quote_list' %}?status=pending&priority=false">
        <p class="text-[#EF7153] text-sm hover:underline">{{ pending_non_urgent }} non-urgent</p>
      </a>
    </div>

    <!-- Jobs Today -->
    <div class="border rounded-xl p-6 text-center shadow hover:shadow-md transition relative">
      <a href="{% url 'job_list' %}?status=scheduled">
        <h2 class="font-bold text-[#293272] text-lg mb-2">Jobs Today</h2>
      </a>
      <a href="{% url 'job_list' %}?status=scheduled&priority=true">
        <p class="text-[#EF7153] text-sm hover:underline">{{ today_urgent }} urgent</p>
      </a>
      <a href="{% url 'job_list' %}?status=scheduled&priority=false">
        <p class="text-[#EF7153] text-sm hover:underline">{{ today_non_urgent }} non-urgent</p>
      </a>
    </div>

    <!-- Jobs Approved -->
    <div class="border rounded-xl p-6 text-center shadow hover:shadow-md transition relative">
      <a href="{% url 'job_list' %}?status=approved">
        <h2 class="font-bold text-[#293272] text-lg mb-2">Jobs Approved</h2>
      </a>
      <a href="{% url 'job_list' %}?status=approved&priority=true">
        <p class="text-[#EF7153] text-sm hover:underline">{{ approved_urgent }} urgent</p>
      </a>
      <a href="{% url 'job_list' %}?status=approved&priority=false">
        <p class="text-[#EF7153] text-sm hover:underline">{{ approved_non_urgent }} non-urgent</p>
      </a>
    </div>
  </div>

  <!-- Calendar -->
  <section>
    <h2 class="text-[#293272] font-bold text-xl mb-3">Calendar Events</h2>

    <!-- Legend -->
    <div class="flex items-center gap-4 mb-3 text-sm">
      <div class="flex items-center gap-2">
        <span class="w-4 h-4 rounded bg-[#293272] inline-block"></span> Jobs
      </div>
      {% if is_member %}
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded bg-[#EF7153] inline-block"></span> Leaves
        </div>
      {% endif %}
    </div>

    <div class="bg-white p-4 rounded-xl shadow w-full overflow-x-auto">
      <div id="calendar"></div>
    </div>
  </section>

  {% if messages %}
  <div
    x-data="{ show: true }"
    x-init="setTimeout(() => show = false, 4000)"
    x-show="show"
    class="fixed top-6 right-6 z-50 bg-green-500 text-white px-4 py-2 rounded shadow-md transition ease-in-out"
  >
    {% for message in messages %}
      {{ message }}
    {% endfor %}
  </div>
  {% endif %}
</main>

{% include 'components/footerTrader.html' %}
{% endblock %}

{% block scripts %}
  <!-- FullCalendar CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');

      function getToolbar() {
        if (window.innerWidth < 640) {
          return {
            left: 'prev,next today',
            center: 'title',
            right: ''
          }
        } else {
          return {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
          }
        }
      }

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: getToolbar(),
        windowResize: function() {
          calendar.setOption('headerToolbar', getToolbar());
        },
        events: 'calendar/events/',
        eventDidMount: function(info) {
          // ðŸ§¹ 1. Remove browser tooltip
          info.el.removeAttribute('title');

          // ðŸ§¹ 2. Disable default <a> link tooltip behavior
          if (info.el.tagName === 'A') {
            info.el.removeAttribute('href');
          }

          // Optional: custom tooltip near event (hover card)
          info.el.addEventListener('mouseenter', function(e) {
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute bg-black text-white text-xs px-2 py-1 rounded shadow';
            tooltip.style.position = 'absolute';
            tooltip.style.top = e.pageY + 10 + 'px';
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.innerText = info.event.title;
            tooltip.id = 'custom-tooltip';
            document.body.appendChild(tooltip);
          });

          info.el.addEventListener('mouseleave', function() {
            const tooltip = document.getElementById('custom-tooltip');
            if (tooltip) tooltip.remove();
          });
        },
        eventMouseEnter: function(info) {
          // Prevent browser tooltip entirely
          info.el.removeAttribute('title');
        }
      });

      calendar.render();
    });
  </script>
{% endblock %}
