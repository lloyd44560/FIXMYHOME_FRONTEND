{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Maintenance Request - FixMyHouse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Tailwind + Alpine -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/kolektif" rel="stylesheet">

  <style>
    body { font-family: 'Lexend', sans-serif; }
    .btn-primary { background-color: #293272; color: white; }
    .btn-primary:hover { background-color: #1f2558; }
    .btn-accent { background-color: #EF7153; color: white; }
    .btn-accent:hover { background-color: #d75f44; }
    a { text-decoration: none !important; }
    a:hover { text-decoration: none !important; }
    .select2-container .select2-selection--single {
      height: 38px; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 1rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 24px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 38px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen font-sans">
  <main class="flex-grow w-full mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-3">
      <h1 class="text-3xl font-bold text-gray-900">My Requests</h1>
      <button class="bg-[#293272] text-white px-3 py-2 rounded-full hover:bg-[#1f2558] transition-colors duration-200 font-medium text-sm sm:text-base flex items-center justify-center gap-1"
              data-bs-toggle="modal" data-bs-target="#addJobModal">
        <i class="bi bi-plus-circle"></i> Add Maintenance Request
      </button>
    </div>


    <!-- Notification -->
    <div id="notification" class="hidden mb-6 p-4 rounded-lg text-white bg-green-500" role="alert"></div>

    <!-- Search Form -->
    <!-- Search Form -->
    <form method="GET" class="flex flex-col sm:flex-row gap-3 p-6 bg-white rounded-t-xl">
      <input type="text" name="q"
             class="w-full sm:flex-grow border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
             placeholder="Search maintenance request..." value="{{ search_query }}">
      <button type="submit"
              class="w-full sm:w-auto bg-[#293272] text-white px-5 py-2 rounded-lg hover:bg-[#1f2558] transition-colors duration-200">
        Search
      </button>
    </form>


    <!-- Messages -->
    {% if messages %}
      <div id="messages" class="mt-3 px-6">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} rounded p-2 mb-2 fade show" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Desktop Table + Mobile Cards -->
    <div class="bg-white rounded-b-xl shadow-lg border border-gray-100 overflow-hidden">
      <!-- Desktop: Table View -->
      <div class="overflow-x-auto hidden sm:block">
        <!-- Filter & Sort Buttons -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4 px-4 pt-4">
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
            <span class="text-gray-700 font-medium text-sm">Filter Options:</span>
            <div class="flex gap-2">
              <button type="button" class="priority-btn px-3 py-1.5 rounded-full text-sm font-medium border border-gray-300 bg-gray-100 hover:bg-blue-50" data-value="urgent">Urgent</button>
              <button type="button" class="priority-btn px-3 py-1.5 rounded-full text-sm font-medium border border-gray-300 bg-gray-100 hover:bg-blue-50" data-value="non-urgent">Non-urgent</button>
              <button type="button" class="priority-btn px-3 py-1.5 rounded-full text-sm font-medium border border-gray-300 bg-gray-100 hover:bg-blue-50" data-value="all">All</button>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
            <span class="text-gray-700 font-medium text-sm">Sort by:</span>
            <div class="flex gap-2">
              <button type="button" class="sort-btn px-3 py-1.5 rounded-full text-sm font-medium border border-gray-300 bg-gray-100 hover:bg-blue-50" data-value="newest">Newest First</button>
              <button type="button" class="sort-btn px-3 py-1.5 rounded-full text-sm font-medium border border-gray-300 bg-gray-100 hover:bg-blue-50" data-value="oldest">Oldest First</button>
            </div>
          </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {

          // --- Filter Buttons ---
          const urgencyButtons = document.querySelectorAll('[data-filter-urgency]');
          const timeButtons = document.querySelectorAll('[data-filter-time]');
          const jobCards = document.querySelectorAll('.job-card');

          // Urgency Filter
          urgencyButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const filter = btn.getAttribute('data-filter-urgency');

              jobCards.forEach(card => {
                if(filter === 'all' || card.dataset.urgency === filter){
                  card.classList.remove('hidden');
                } else {
                  card.classList.add('hidden');
                }
              });

              // Active state styling
              urgencyButtons.forEach(b => b.classList.remove('bg-blue-700','text-white'));
              btn.classList.add('bg-blue-700','text-white');
            });
          });

          // Time Filter
          timeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const filter = btn.getAttribute('data-filter-time');

              // Simple toggle visual, actual sorting requires backend or JS array manipulation
              timeButtons.forEach(b => b.classList.remove('bg-light-blue-700','text-white'));
              btn.classList.add('bg-light-blue-700','text-white');
            });
          });

        });
        </script>
        <table class="min-w-full text-left border-collapse">
          <thead class="bg-gradient-to-r from-gray-50 to-gray-100 sticky top-0 z-10">
            <tr>
              <th class="px-3 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-10">#</th>
              <th class="px-3 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Job Code</th>
              <th class="px-3 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">Status</th>
              <th class="px-3 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">Priority</th>
              <th class="px-3 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Issues</th>
              <th class="px-3 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden lg:table-cell">Additional Notes</th>
              <th class="px-3 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Images</th>
              <th class="px-3 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-32">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for job in jobs %}
            <tr class="hover:bg-gray-50 transition-all duration-150">
              <td class="px-3 py-4 text-center text-sm text-gray-600">{{ forloop.counter }}</td>
              <td class="px-3 py-4 font-mono text-sm font-bold text-gray-900">{{ job.job_code }}</td>
              <td class="px-3 py-4 text-center">
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold
                  {% if job.status == 'Pending' %}bg-yellow-100 text-yellow-800
                  {% elif job.status == 'In Progress' %}bg-blue-100 text-blue-800
                  {% elif job.status == 'Completed' %}bg-green-100 text-green-800
                  {% else %}bg-red-100 text-red-800{% endif %}">
                  <i class="bi bi-circle-fill text-[10px] mr-1"></i> {{ job.status }}
                </span>
              </td>
              <td class="px-3 py-4 text-center">
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold
                  {% if job.priority %}bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-sm
                  {% else %}bg-gray-200 text-gray-700{% endif %}">
                  {% if job.priority %}Urgent{% else %}Non-urgent{% endif %}
                </span>
              </td>
              <td class="px-3 py-4 text-sm text-gray-700">{{ job.category.description }}</td>
              <td class="px-3 py-4 text-sm text-gray-600 hidden lg:table-cell">{{ job.notes|truncatechars:60 }}</td>
              <td class="px-3 py-4 text-center">
                <div class="flex justify-center gap-1">
                  {% for img in job.images.all %}
                  <img src="{{ img.image.url }}"
                       class="h-10 w-10 rounded-lg object-cover cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all"
                       onclick="openImageModal('{{ job.id }}', {{ forloop.counter0 }})">
                  {% endfor %}
                </div>
              </td>
              <td class="px-3 py-4 text-center">
                <div class="flex justify-center gap-2 text-sm">
                  <button class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1 text-xs font-medium"
                          data-bs-toggle="modal" data-bs-target="#editJobModal{{ job.id }}">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <a href="{% url 'delete_job' job.id %}" class="text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1 text-xs font-medium"
                     onclick="return confirm('Delete this job?')">
                    <i class="bi bi-trash"></i> Delete
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-12">
                <div class="flex flex-col items-center gap-3 text-gray-500">
                  <i class="bi bi-tools text-5xl"></i>
                  <p class="text-lg font-medium">No maintenance requests available</p>
                </div>
 (continues...)
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
          </div>

<!-- Mobile: Messenger-Style Job List -->
        <div class="sm:hidden p-4 flex flex-col space-y-3 h-screen overflow-y-auto">

          <!-- Sticky Mobile Filters -->
          <div x-data="{ openFilters: false }" class="sticky top-0 z-10 bg-white/95 backdrop-blur-md border-b border-gray-200 p-3 rounded-md mb-3">
            <!-- Toggle Button -->
            <button @click="openFilters = !openFilters"
                    class="w-full flex justify-between items-center px-4 py-2 bg-white border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
              <span>Filter Options</span>
              <i :class="openFilters ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"></i>
            </button>

            <!-- Filter Card -->
            <div x-show="openFilters" x-transition
                 class="mt-2 bg-white border border-gray-200 rounded-lg shadow-sm p-4 space-y-4 overflow-auto max-h-[250px] sm:max-h-[300px]">

              <!-- Urgency -->
              <div>
                <span class="block text-xs font-medium text-gray-500 mb-2">Urgency</span>
                <div class="flex flex-wrap gap-2">
                  <button type="button" data-filter-urgency="urgent" class="flex-1 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium bg-blue-600 text-white hover:bg-blue-700">Urgent</button>
                  <button type="button" data-filter-urgency="non-urgent" class="flex-1 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium bg-purple-600 text-white hover:bg-purple-700">Non-Urgent</button>
                  <button type="button" data-filter-urgency="all" class="flex-1 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">All</button>
                </div>
              </div>

              <!-- Time -->
              <div>
                <span class="block text-xs font-medium text-gray-500 mb-2">Time</span>
                <div class="flex flex-wrap gap-2">
                  <button type="button" data-filter-time="newest" class="flex-1 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">Newest First</button>
                  <button type="button" data-filter-time="oldest" class="flex-1 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">Oldest First</button>
                </div>
              </div>

            </div>
          </div>

          <!-- Job Thread Items -->
          <div class="flex flex-col space-y-3">
            {% for job in jobs %}
            <div class="flex items-start gap-3 job-card" data-urgency="{{ job.urgency }}" data-time="{{ job.created_at|date:'U' }}">

             <!-- Avatar -->
                       <!-- Avatar -->
            <div class="flex-shrink-0 mt-1">
              {% if job.images.all %}
                <img src="{{ job.images.all.0.image.url }}" alt="Job Image"
                     class="w-10 h-10 rounded-full object-cover border border-gray-200 shadow-sm" loading="lazy">
              {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center border border-gray-200 shadow-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5.121 17.804A10.05 10.05 0 0112 15c2.21 0 4.22.71 5.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </div>
              {% endif %}
            </div>


              <!-- Bubble -->
              <div class="flex-1 min-w-0">
                <div class="p-3 rounded-xl shadow-sm
                            {% if job.status == 'Pending' %}bg-yellow-50
                            {% elif job.status == 'In Progress' %}bg-blue-50
                            {% elif job.status == 'Completed' %}bg-green-50
                            {% else %}bg-gray-50{% endif %}">

                  <!-- Title / Issue -->
                  <h3 class="font-semibold text-gray-800 text-sm sm:text-base truncate break-words">
                    {{ job.category.description }}
                  </h3>

                  <!-- Status -->
                  <p class="text-xs sm:text-sm text-gray-500 flex items-center mt-1">
                    <i class="bi bi-circle-fill text-[10px] sm:text-[12px] mr-1
                      {% if job.status == 'Pending' %}text-yellow-500
                      {% elif job.status == 'In Progress' %}text-blue-500
                      {% elif job.status == 'Completed' %}text-green-500
                      {% else %}text-red-500{% endif %}">
                    </i>
                    {{ job.status }}
                  </p>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex flex-col items-end gap-2 ml-2 mt-1">
                <button class="p-2 text-blue-500 hover:text-blue-700 rounded-full" data-bs-toggle="modal" data-bs-target="#editJobModal{{ job.id }}">
                  <i class="bi bi-pencil text-lg"></i>
                </button>
                <a href="{% url 'delete_job' job.id %}" class="p-2 text-red-500 hover:text-red-700 rounded-full"
                   onclick="return confirm('Delete this job?')">
                  <i class="bi bi-trash text-lg"></i>
                </a>
              </div>
            </div>
            {% empty %}
            <!-- Empty State -->
            <div class="flex flex-col items-center justify-center min-h-[200px] text-center py-12 px-4">
              <i class="bi bi-tools text-5xl text-gray-400 mb-3"></i>
              <p class="text-lg font-medium text-gray-600">No maintenance requests available</p>
            </div>
            {% endfor %}
          </div>

        </div>

        <!-- Filter JS -->
        <script>
        document.addEventListener("DOMContentLoaded", function () {

          const urgencyButtons = document.querySelectorAll('[data-filter-urgency]');
          const timeButtons = document.querySelectorAll('[data-filter-time]');
          const jobCards = document.querySelectorAll('.job-card');

          // Urgency Filter
          urgencyButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const filter = btn.getAttribute('data-filter-urgency');
              jobCards.forEach(card => {
                if(filter === 'all' || card.dataset.urgency === filter){
                  card.classList.remove('hidden');
                } else {
                  card.classList.add('hidden');
                }
              });
              urgencyButtons.forEach(b => b.classList.remove('bg-blue-700','text-white'));
              btn.classList.add('bg-blue-700','text-white');
            });
          });

          // Time Filter (visual only)
          timeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              timeButtons.forEach(b => b.classList.remove('bg-blue-700','text-white'));
              btn.classList.add('bg-blue-700','text-white');
            });
          });

        });
        </script>
    <!-- Pagination -->
   <!-- Pagination -->
    <div class="p-4 sm:p-6">
      <nav aria-label="Job Pagination">
        <ul class="flex flex-wrap justify-center gap-2 text-center">
          {% if jobs.has_previous %}
          <li class="flex-1 sm:flex-auto">
            <a class="block px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100"
               href="?page={{ jobs.previous_page_number }}&q={{ search_query }}">Previous</a>
          </li>
          {% else %}
          <li class="flex-1 sm:flex-auto">
            <span class="block px-4 py-2 text-sm font-medium text-gray-400 bg-white border border-gray-300 rounded-lg cursor-not-allowed">Previous</span>
          </li>
          {% endif %}

          {% for num in jobs.paginator.page_range %}
          <li class="flex-1 sm:flex-auto">
            {% if jobs.number == num %}
            <span class="block px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-lg">{{ num }}</span>
            {% else %}
            <a class="block px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100"
               href="?page={{ num }}&q={{ search_query }}">{{ num }}</a>
            {% endif %}
          </li>
          {% endfor %}

          {% if jobs.has_next %}
          <li class="flex-1 sm:flex-auto">
            <a class="block px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100"
               href="?page={{ jobs.next_page_number }}&q={{ search_query }}">Next</a>
          </li>
          {% else %}
          <li class="flex-1 sm:flex-auto">
            <span class="block px-4 py-2 text-sm font-medium text-gray-400 bg-white border border-gray-300 rounded-lg cursor-not-allowed">Next</span>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>


  <!-- Image Gallery Modal (Global) -->
  <div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-black border-0 overflow-hidden">
        <div class="relative">
          <button type="button" class="absolute top-4 right-4 z-10 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full w-10 h-10 flex items-center justify-center transition" data-bs-dismiss="modal">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          <img id="galleryImage" src="" class="w-full h-auto max-h-[80vh] object-contain mx-auto">
          <button id="prevImageBtn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition opacity-0 pointer-events-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button id="nextImageBtn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition opacity-0 pointer-events-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
            <span id="imageCounter">1 / 1</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Job Modals -->
  {% for job in jobs %}
  <div class="modal fade" id="editJobModal{{ job.id }}" tabindex="-1" aria-labelledby="editJobModalLabel{{ job.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="{% url 'edit_job' job.id %}" class="modal-content rounded-xl shadow-xl overflow-hidden" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header bg-white p-5 border-b border-gray-200 flex justify-between items-center">
          <h5 class="text-xl font-bold flex items-center gap-2 m-0" id="editJobModalLabel{{ job.id }}" style="color: #006ffd;">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #006ffd;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Edit Request: {{ job.job_code }}
          </h5>
          <button type="button" class="text-gray-500 hover:text-gray-700 text-2xl font-light transition-colors duration-200 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100" data-bs-dismiss="modal">×</button>
        </div>
        <div class="modal-body p-6 space-y-5 bg-gray-50">
          <!-- Category -->
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-1.5">Issue Category</label>
            <select name="category" id="editCategory{{ job.id }}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd] transition edit-category" data-job-id="{{ job.id }}">
              <option value="" disabled>-- Select Service Category --</option>
              {% for service in services %}
              <option value="{{ service.id }}" data-isurgent="{{ service.is_urgent|yesno:'true,false' }}" {% if service.id == job.category.id %}selected{% endif %}>
                {{ service.description }} {% if service.is_urgent %}(Urgent){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Issue Date Buttons -->
          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">When did the issue occur?</label>
            <div id="edit_renter_issue_date_group_{{ job.id }}" class="grid grid-cols-2 gap-3">
              <button type="button" class="edit-issue-btn px-4 py-2 rounded-lg border text-center" data-value="YESTERDAY">YESTERDAY</button>
              <button type="button" class="edit-issue-btn px-4 py-2 rounded-lg border text-center" data-value="TODAY">TODAY</button>
              <button type="button" class="edit-issue-btn px-4 py-2 rounded-lg border text-center" data-value="ONGOING">ONGOING</button>
              <button type="button" class="edit-issue-btn px-4 py-2 rounded-lg border text-center" data-value="UNSURE">UNSURE</button>
            </div>
            <input type="hidden" name="renter_issue_date" id="edit_renter_issue_date_{{ job.id }}" value="{{ job.renter_issue_date|default:'' }}">
          </div>

          <!-- Availability -->
          <div x-data="{ days: {{ job.renter_availability_schedule.days|default:'[]'|safe }}, times: {{ job.renter_availability_schedule.times|default:'[]'|safe }}, toggleDay(day) { this.days.includes(day) ? this.days = this.days.filter(d => d !== day) : this.days.push(day); }, toggleTime(time) { this.times.includes(time) ? this.times = this.times.filter(t => t !== time) : this.times.push(time); } }" class="space-y-3">
            <label class="block text-sm font-semibold text-gray-800">Your Availability</label>
            <div class="flex flex-wrap gap-2">
              <template x-for="day in ['MON','TUE','WED','THU','FRI','SAT','SUN']" :key="day">
                <button type="button" @click="toggleDay(day)" :class="days.includes(day) ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 rounded-full text-sm font-medium transition"><span x-text="day"></span></button>
              </template>
            </div>
            <div class="flex flex-wrap gap-2">
              <template x-for="time in ['MORNING','AFTERNOON','EVENING']" :key="time">
                <button type="button" @click="toggleTime(time)" :class="times.includes(time) ? (time === 'MORNING' ? 'bg-teal-500 text-white' : 'bg-blue-600 text-white') : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 rounded-full text-sm font-medium transition"><span x-text="time"></span></button>
              </template>
            </div>
            <input type="hidden" name="renter_availability_schedule" :value="JSON.stringify({days: days, times: times})">
          </div>

          <!-- Fixed Before? -->
          <div x-data="{ fixed: '{{ job.issue_been_fixed_before|lower }}' }">
            <p class="text-sm font-semibold text-gray-800 mb-2">Has this issue been fixed before?</p>
            <div class="flex flex-wrap gap-2">
              <button type="button" @click="fixed = 'yes'" :class="fixed === 'yes' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full text-sm font-medium transition">YES</button>
              <button type="button" @click="fixed = 'no'" :class="fixed === 'no' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full46 text-sm font-medium transition">NO</button>
              <button type="button" @click="fixed = 'unsure'" :class="fixed === 'unsure' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full text-sm font-medium transition">UNSURE</button>
            </div>
            <input type="hidden" name="issue_been_fixed_before" :value="fixed">
          </div>

          <!-- Existing Images -->
          {% if job.images.all %}
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-2">Existing Images</label>
            <div class="flex flex-wrap gap-3">
              {% for image in job.images.all %}
              <div class="relative group">
                <img src="{{ image.image.url }}" alt="Issue" class="w-24 h-24 object-cover rounded-lg border">
                <label class="absolute top-1 right-1 bg-white rounded-full p-1 shadow cursor-pointer opacity-0 group-hover:opacity-100 transition">
                  <input type="checkbox" name="delete_images" value="{{ image.id }}" class="sr-only">
                  <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- New Image Upload -->
          <div id="edit-image-upload-container-{{ job.id }}" class="space-y-2"></div>
          <div id="edit-image-preview-{{ job.id }}" class="flex flex-wrap gap-2 mt-2"></div>
          <div class="flex gap-2 mt-2">
            <button type="button" data-job-id="{{ job.id }}" class="add-edit-image-btn text-sm px-4 py-1.5 bg-[#006ffd] hover:bg-[#005edc] text-white rounded-lg font-medium transition flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Another
            </button>
            <button type="button" data-job-id="{{ job.id }}" class="clear-edit-images-btn text-sm px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition">Clear All</button>
          </div>

          <!-- Status -->
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-2">Current Status</label>
            <ol class="space-y-2">
              {% for code, label in job.STATUS_CHOICES %}
              <li class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold {% if job.status == code %}bg-[#006ffd] text-white{% else %}bg-gray-200 text-gray-500{% endif %}">{{ forloop.counter }}</div>
                <span class="{% if job.status == code %}font-bold text-gray-900{% else %}text-gray-500{% endif %}">{{ label }}</span>
              </li>
              {% endfor %}
            </ol>
          </div>

          <!-- Bids -->
          {% if bids %}
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-2">Bids Received</label>
            <div class="bg-white rounded-lg border overflow-hidden">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr><th class="px-4 py-2 text-left font-medium text-gray-700">Trader</th><th class="px-4 py-2 text-left font-medium text-gray-700">Approved By</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  {% for bid in bids %}
                  {% if bid.jobs.id == job.id %}
                  <tr><td class="px-4 py-2">{{ bid.trader.name }}</td><td class="px-4 py-2">{{ bid.approved_by.name|default:"—" }}</td></tr>
                  {% endif %}
                  {% empty %}
                  <tr><td colspan="2" class="px-4 py-2 text-center text-gray-500">No bids yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          <!-- Notes -->
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-1.5">Additional Notes</label>
            <textarea name="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd] resize-none" placeholder="Update notes...">{{ job.notes }}</textarea>
          </div>
          <input type="hidden" name="priority" id="editPriority{{ job.id }}">
        </div>
        <div class="modal-footer bg-white p-5 border-t border-gray-200 flex justify-end gap-3">
          <button type="submit" class="px-6 py-2.5 bg-[#006ffd] hover:bg-[#005edc] text-white rounded-lg font-semibold transition shadow-md">Save Changes</button>
          <button type="button" data-bs-dismiss="modal" class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- Add Job Modal -->
  <div class="modal fade" id="addJobModal" tabindex="-1" aria-labelledby="addJobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="{% url 'add_job' %}" class="modal-content rounded-xl shadow-xl overflow-hidden" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header bg-white p-5 border-b border-gray-200 flex justify-between items-center">
          <h5 class="text-xl font-bold flex items-center gap-2 m-0" id="addJobModalLabel" style="color: #006ffd;">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #006ffd;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add New Maintenance Request
          </h5>
          <button type="button" class="text-gray-500 hover:text-gray-700 text-2xl font-light transition-colors duration-200 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100" data-bs-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body p-6 space-y-5 bg-gray-50">
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-1.5">Describe your Issue *</label>
            <select name="category" id="categorySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd] transition" required>
              <option value="" disabled selected>-- Select Service Category --</option>
              {% for service in services %}
              <option value="{{ service.id }}" data-isurgent="{{ service.is_urgent|yesno:'true,false' }}">
                {{ service.description }} {% if service.is_urgent %}<span class="text-red-600 font-medium">(Urgent)</span>{% endif %}
              </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-1.5">Additional Information</label>
            <textarea name="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd] resize-none" placeholder="Describe the issue in detail..."></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">When did the issue occur?</label>
            <div id="renter_issue_date_group" class="grid grid-cols-2 gap-2">
              <button type="button" class="issue-btn px-4 py-2 rounded-full border text-center" data-value="YESTERDAY">YESTERDAY</button>
              <button type="button" class="issue-btn px-4 py-2 rounded-full border text-center" data-value="TODAY">TODAY</button>
              <button type="button" class="issue-btn px-4 py-2 rounded-full border text-center" data-value="ONGOING">ONGOING</button>
              <button type="button" class="issue-btn px-4 py-2 rounded-full border text-center" data-value="UNSURE">UNSURE</button>
            </div>
            <input type="hidden" name="renter_issue_date" id="renter_issue_date">
          </div>
          <div x-data="{ days: [], times: [], toggleDay(day) { this.days.includes(day) ? this.days = this.days.filter(d => d !== day) : this.days.push(day); }, toggleTime(time) { this.times.includes(time) ? this.times = this.times.filter(t => t !== time) : this.times.push(time); } }" class="space-y-3">
            <label class="block text-sm font-semibold text-gray-800">Your Availability</label>
            <div class="flex flex-wrap gap-2">
              <template x-for="day in ['MON','TUE','WED','THU','FRI','SAT','SUN']" :key="day">
                <button type="button" @click="toggleDay(day)" :class="days.includes(day) ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 rounded-full text-sm font-medium transition"><span x-text="day"></span></button>
              </template>
            </div>
            <div class="flex flex-wrap gap-2">
              <template x-for="time in ['MORNING','AFTERNOON','EVENING']" :key="time">
                <button type="button" @click="toggleTime(time)" :class="times.includes(time) ? (time === 'MORNING' ? 'bg-teal-500 text-white' : 'bg-blue-600 text-white') : 'bg-gray-100 text-gray-700 hover:bg-gray-200'" class="px-4 py-2 rounded-full text-sm font-medium transition"><span x-text="time"></span></button>
              </template>
            </div>
            <input type="hidden" name="renter_availability_schedule" :value="JSON.stringify({days: days, times: times})">
          </div>
          <div x-data="{ fixed: 'no' }">
            <p class="text-sm font-semibold text-gray-800 mb-2">Has this issue been fixed before?</p>
            <div class="flex flex-wrap gap-2">
              <button type="button" @click="fixed = 'yes'" :class="fixed === 'yes' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full text-sm font-medium transition">YES</button>
              <button type="button" @click="fixed = 'no'" :class="fixed === 'no' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full text-sm font-medium transition">NO</button>
              <button type="button" @click="fixed = 'unsure'" :class="fixed === 'unsure' ? 'bg-[#006ffd] text-white' : 'bg-white border border-[#006ffd] text-[#006ffd] hover:bg-[#006ffd]/10'" class="px-5 py-2 rounded-full text-sm font-medium transition">UNSURE</button>
            </div>
            <input type="hidden" name="issue_been_fixed_before" :value="fixed">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-1.5">Upload Media (max 5)</label>
            <div id="image-upload-container" class="space-y-2">
              <input type="file" name="images" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd]">
            </div>
            <div class="flex items-center gap-2 mt-2">
              <button type="button" id="add-image-btn" class="text-sm px-4 py-1.5 bg-[#006ffd] hover:bg-[#005edc] text-white rounded-lg font-medium transition flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Another
              </button>
              <button type="button" id="clear-images-btn" class="text-sm px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition">Clear All</button>
            </div>
            <div id="image-preview" class="flex flex-wrap gap-2 mt-2"></div>
            <p id="image-limit-msg" class="text-red-600 text-xs mt-1 hidden">Maximum 5 images allowed.</p>
          </div>
          <input type="hidden" name="priority" id="prioritySelect">
        </div>
        <div class="modal-footer bg-white p-5 border-t border-gray-200 flex justify-end gap-3">
          <button type="submit" class="px-6 py-2.5 bg-[#006ffd] hover:bg-[#005edc] text-white rounded-lg font-semibold transition shadow-md">Submit Request</button>
          <button type="button" data-bs-dismiss="modal" class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Main JS: Gallery + Filters + Modals -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // === IMAGE GALLERY ===
    const jobImages = {};
    {% for job in jobs %}
      jobImages[{{ job.id }}] = [{% for img in job.images.all %}"{{ img.image.url }}",{% endfor %}];
    {% endfor %}
    let currentJobId = null, currentIndex = 0, modalInstance = null;

    window.openImageModal = function (jobId, index) {
      currentJobId = jobId; currentIndex = index;
      const images = jobImages[jobId];
      if (!images || images.length === 0) return;
      document.getElementById('galleryImage').src = images[currentIndex];
      updateCounter(images.length); updateArrows(images.length);
      modalInstance = new bootstrap.Modal(document.getElementById('imageGalleryModal'));
      modalInstance.show();
    };

    function updateCounter(total) { document.getElementById('imageCounter').textContent = `${currentIndex + 1} / ${total}`; }
    function updateArrows(total) {
      const prev = document.getElementById('prevImageBtn'), next = document.getElementById('nextImageBtn');
      prev.classList.toggle('opacity-0', currentIndex === 0); prev.classList.toggle('pointer-events-none', currentIndex === 0);
      next.classList.toggle('opacity-0', currentIndex === total - 1); next.classList.toggle('pointer-events-none', currentIndex === total - 1);
    }

    document.getElementById('prevImageBtn').onclick = () => { if (currentIndex <= 0) return; currentIndex--; const imgs = jobImages[currentJobId]; document.getElementById('galleryImage').src = imgs[currentIndex]; updateCounter(imgs.length); updateArrows(imgs.length); };
    document.getElementById('nextImageBtn').onclick = () => { const imgs = jobImages[currentJobId]; if (currentIndex >= imgs.length - 1) return; currentIndex++; document.getElementById('galleryImage').src = imgs[currentIndex]; updateCounter(imgs.length); updateArrows(imgs.length); };

    // Keyboard & Swipe
    document.getElementById('imageGalleryModal').addEventListener('keydown', e => { if (e.key === 'ArrowLeft') prevImageBtn.click(); if (e.key === 'ArrowRight') nextImageBtn.click(); if (e.key === 'Escape') modalInstance.hide(); });
    let touchStartX = 0;
    document.getElementById('galleryImage').addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
    document.getElementById('galleryImage').addEventListener('touchend', e => { const diff = touchStartX - e.changedTouches[0].screenX; if (Math.abs(diff) > 50) diff > 0 ? nextImageBtn.click() : prevImageBtn.click(); });

    // === FILTER & SORT (Desktop) ===
    const tableBody = document.querySelector('table tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr')).filter(r => !r.classList.contains('empty-row'));
    let currentPriority = 'all', currentSort = 'newest';
    function filterAndSort() {
      rows.forEach(row => {
        const prioritySpan = row.querySelector('td:nth-child(4) span');
        if (!prioritySpan) return;
        const isUrgent = prioritySpan.textContent.trim() === 'Urgent';
        row.style.display = (currentPriority === 'all' || (currentPriority === 'urgent' && isUrgent) || (currentPriority === 'non-urgent' && !isUrgent)) ? '' : 'none';
      });
      const visible = rows.filter(r => r.style.display !== 'none');
      const sorted = currentSort === 'newest' ? visible.reverse() : visible;
      sorted.forEach(r => tableBody.appendChild(r));
    }
    document.querySelectorAll('.priority-btn').forEach(btn => btn.addEventListener('click', () => { currentPriority = btn.dataset.value; document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('bg-blue-600','text-black','shadow')); btn.classList.add('bg-blue-600','text-black','shadow'); filterAndSort(); }));
    document.querySelectorAll('.sort-btn').forEach(btn => btn.addEventListener('click', () => { currentSort = btn.dataset.value; document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('bg-blue-600','text-black','shadow')); btn.classList.add('bg-blue-600','text-black','shadow'); filterAndSort(); }));
    document.querySelector('.priority-btn[data-value="all"]').classList.add('bg-blue-600','text-black','shadow');
    document.querySelector('.sort-btn[data-value="newest"]').classList.add('bg-blue-600','text-black','shadow');

    // === MOBILE FILTER & SORT ===
    const mobileCards = Array.from(document.querySelectorAll('.sm\\:hidden > div')).filter(c => !c.classList.contains('empty-row'));
    let mobilePriority = 'all', mobileSort = 'newest';
    function filterSortMobile() {
      mobileCards.forEach(card => {
        const prioritySpan = card.querySelector('div.flex.gap-3 span:nth-child(2)');
        if (!prioritySpan) return;
        const isUrgent = prioritySpan.textContent.trim() === 'Urgent';
        card.style.display = (mobilePriority === 'all' || (mobilePriority === 'urgent' && isUrgent) || (mobilePriority === 'non-urgent' && !isUrgent)) ? '' : 'none';
      });
      const visible = mobileCards.filter(c => c.style.display !== 'none');
      const sorted = mobileSort === 'newest' ? visible.reverse() : visible;
      const container = document.querySelector('.sm\\:hidden');
      sorted.forEach(c => container.appendChild(c));
    }
    document.querySelectorAll('.mobile-priority-btn').forEach(btn => btn.addEventListener('click', () => { mobilePriority = btn.dataset.value; document.querySelectorAll('.mobile-priority-btn').forEach(b => b.classList.remove('bg-blue-600','text-black','shadow')); btn.classList.add('bg-blue-600','text-black','shadow'); filterSortMobile(); }));
    document.querySelectorAll('.mobile-sort-btn').forEach(btn => btn.addEventListener('click', () => { mobileSort = btn.dataset.value; document.querySelectorAll('.mobile-sort-btn').forEach(b => b.classList.remove('bg-blue-600','text-black','shadow')); btn.classList.add('bg-blue-600','text-black','shadow'); filterSortMobile(); }));
    document.querySelector('.mobile-priority-btn[data-value="all"]').classList.add('bg-blue-600','text-black','shadow');
    document.querySelector('.mobile-sort-btn[data-value="newest"]').classList.add('bg-blue-600','text-black','shadow');

    // === EDIT IMAGE UPLOAD ===
    document.querySelectorAll('.add-edit-image-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const jobId = btn.dataset.jobId;
        const container = document.getElementById(`edit-image-upload-container-${jobId}`);
        const preview = document.getElementById(`edit-image-preview-${jobId}`);
        if (container.querySelectorAll('input').length >= 5) return;
        const input = Object.assign(document.createElement('input'), { type: 'file', name: 'images', accept: 'image/*', className: 'hidden' });
        container.appendChild(input); input.click();
        input.onchange = () => {
          if (!input.files[0]) return;
          const wrapper = document.createElement('div'); wrapper.className = 'relative';
          const img = Object.assign(document.createElement('img'), { src: URL.createObjectURL(input.files[0]), className: 'w-24 h-24 object-cover rounded border' });
          img.onload = () => URL.revokeObjectURL(img.src);
          const remove = Object.assign(document.createElement('button'), { type: 'button', innerHTML: '×', className: 'absolute top-0 right-0 bg-white rounded-full p-1 text-red-600 shadow' });
          remove.onclick = () => { wrapper.remove(); input.remove(); };
          wrapper.append(img, remove); preview.appendChild(wrapper);
        };
      });
    });
    document.querySelectorAll('.clear-edit-images-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const jobId = btn.dataset.jobId;
        document.getElementById(`edit-image-upload-container-${jobId}`).innerHTML = '';
        document.getElementById(`edit-image-preview-${jobId}`).innerHTML = '';
      });
    });

    // === ADD IMAGE UPLOAD ===
    const addContainer = document.getElementById('image-upload-container');
    const addPreview = document.getElementById('image-preview');
    const addBtn = document.getElementById('add-image-btn');
    const clearBtn = document.getElementById('clear-images-btn');
    const limitMsg = document.getElementById('image-limit-msg');
    addBtn.onclick = () => {
      if (addContainer.querySelectorAll('input').length >= 5) { limitMsg.classList.remove('hidden'); return; }
      limitMsg.classList.add('hidden');
      const input = Object.assign(document.createElement('input'), { type: 'file', name: 'images', accept: 'image/*', className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd]' });
      addContainer.appendChild(input);
    };
    clearBtn.onclick = () => { addContainer.innerHTML = '<input type="file" name="images" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006ffd] focus:border-[#006ffd]">'; addPreview.innerHTML = ''; limitMsg.classList.add('hidden'); };

    // === ISSUE DATE BUTTONS ===
    document.querySelectorAll('.issue-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.issue-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-black'));
        btn.classList.add('bg-teal-500', 'text-white');
        document.getElementById('renter_issue_date').value = JSON.stringify({ value: btn.dataset.value });
      };
    });
    {% for job in jobs %}
    (function() {
      const jobId = "{{ job.id }}";
      const hidden = document.getElementById("edit_renter_issue_date_" + jobId);
      const buttons = document.querySelectorAll("#edit_renter_issue_date_group_" + jobId + " .edit-issue-btn");
      if (hidden.value) buttons.forEach(btn => { if (btn.dataset.value === hidden.value) btn.classList.add('bg-teal-500', 'text-white'); });
      buttons.forEach(btn => btn.onclick = () => { buttons.forEach(b => b.classList.remove('bg-teal-500', 'text-white')); btn.classList.add('bg-teal-500', 'text-white'); hidden.value = btn.dataset.value; });
    })();
    {% endfor %}

    // === SELECT2 + PRIORITY ===
    $('#categorySelect').select2({ placeholder: "-- Select Service Category --", width: '100%', dropdownParent: $('#addJobModal') });
    $('.edit-category').each(function() { $(this).select2({ placeholder: "-- Select Service Category --", width: '100%', dropdownParent: $(this).closest('.modal') }); });
    $('#categorySelect').on('select2:select', function() { const urgent = $(this).find(':selected').data('isurgent'); $('#prioritySelect').val(urgent ? 'true' : 'false'); });
    $('.edit-category').on('select2:select', function() { const urgent = $(this).find(':selected').data('isurgent'); const id = $(this).data('job-id'); $('#editPriority' + id).val(urgent ? 'true' : 'false'); });

    // === AUTO HIDE MESSAGES ===
    setTimeout(() => { const msg = document.getElementById('messages'); if (msg) { msg.style.transition = 'opacity 0.5s'; msg.style.opacity = '0'; setTimeout(() => msg.remove(), 500); } }, 5000);
  });
  </script>
</body>
</html>