{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Condition Reports</title>

    <!-- Bootstrap 5.3 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Font (modern & clean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #293272;
            --primary-dark: #1f2558;
            --accent: #EF7153;
            --accent-dark: #d75f44;
            --gray-100: #f8fafc;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-800: #1e293b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
            --radius: 12px;
            --transition: all 0.25s ease;
        }
        body { font-family: 'Inter', sans-serif; background: #f5f7fa; color: var(--gray-800); }
        .btn-primary { background: var(--primary); border: none; border-radius: var(--radius); font-weight: 600; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-accent { background: var(--accent); border: none; border-radius: var(--radius); font-weight: 600; }
        .btn-accent:hover { background: var(--accent-dark); }
        .card { border: none; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .table { margin-bottom: 0; }
        .table thead { background: var(--gray-100); }
        .form-control, .form-select {
            border-radius: var(--radius);
            border: 1.5px solid var(--gray-200);
            padding: 0.65rem 1rem;
            transition: var(--transition);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(41, 50, 114, 0.15);
        }
        .modal-content { border-radius: var(--radius); border: none; box-shadow: var(--shadow-lg); }
        @media (max-width: 768px) {
            .table-responsive { font-size: 0.9rem; }
            .btn-sm { font-size: 0.8rem; padding: 0.4rem 0.7rem; }
            .modal-xl-custom { max-width: 98vw !important; }
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4 py-md-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <h2 class="fw-bold text-primary mb-0">Condition Reports</h2>
        <button type="button" class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addConditionReportModal">
            <i class="bi bi-plus-circle me-2"></i>Add Report
        </button>
    </div>

    <!-- Filter & Search Row -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md-4">
                    <form method="get">
                        <select name="room_name" class="form-select" onchange="this.form.submit()">
                            <option value="">All Rooms</option>
                            {% for name in room_names %}
                                <option value="{{ name }}" {% if request.GET.room_name == name %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                <div class="col-12 col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search reports...">
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Reports Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Report No.</th>
                        <th>Date</th>
                        <th>Renter</th>
                        <th>File</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    {% for report in reports %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><strong>{{ report.report_number }}</strong></td>
                        <td>{{ report.date_created|date:"M d, Y" }}</td>
                        <td>{{ report.renter.user.get_full_name }}</td>
                        <td>
                            {% if report.uploaded_file %}
                                <a href="{{ report.uploaded_file.url }}" target="_blank" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i>
                                </a>
                            {% else %}
                                <span class="text-muted small">â€”</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editReportModal_{{ report.id }}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-4"></i><br>No reports yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Condition Report Modal (Modern & Mobile-Friendly) -->
<div class="modal fade" id="addConditionReportModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-xl-custom modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content overflow-hidden" style="height: 92vh;">
            <form id="mainConditionReportForm" method="post" action="{% url 'save_condition_report' %}" enctype="multipart/form-data" class="h-100 d-flex flex-column">
                {% csrf_token %}
                <div class="modal-header bg-primary text-white">
                    <h4 class="modal-title fw-bold"><i class="bi bi-file-earmark-text me-2"></i> Create Condition Report</h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body flex-grow-1 overflow-auto">
                    <div class="row g-0 h-100">
                        <!-- Left Sidebar -->
                        <div class="col-md-4 bg-light border-end p-4">
                            <h6 class="fw-bold text-primary mb-3">Report Info</h6>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Report Number <span class="text-danger">*</span></label>
                                <input type="text" name="report_number" class="form-control" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Attach File</label>
                                <input type="file" name="uploaded_file" class="form-control">
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-primary mb-0">Rooms</h6>
                                <button type="button" class="btn btn-success btn-sm" onclick="addRoomBlock()">
                                    <i class="bi bi-plus"></i> Add Room
                                </button>
                            </div>
                            <ul class="list-group" id="roomListSidebar"></ul>
                        </div>
                        <!-- Right Content -->
                        <div class="col-md-8 p-4" id="roomsContainer">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-house display-1"></i>
                                <h5 class="mt-3">No rooms added yet</h5>
                                <p>Click "Add Room" to start documenting.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="submit" class="btn btn-primary">Save Report</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    
                </div>
            </form>
        </div>
    </div>
</div>


{% for report in reports %}
<!-- EDIT MODAL FOR REPORT {{ report.id }} -->
<div class="modal fade" id="editReportModal_{{ report.id }}" tabindex="-1" aria-labelledby="editModalLabel_{{ report.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content overflow-hidden" style="height: 92vh;">
            <form method="POST" action="{% url 'edit_condition_report' report.id %}" enctype="multipart/form-data" class="h-100 d-flex flex-column">
                {% csrf_token %}
                <div class="modal-header bg-warning text-dark">
                    <h4 class="modal-title fw-bold">
                        <i class="bi bi-pencil-square me-2"></i> Edit Report: {{ report.report_number }}
                    </h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body flex-grow-1 overflow-auto">
                    <div class="row g-0 h-100">
                        <!-- Left Sidebar -->
                        <div class="col-md-4 bg-light border-end p-4">
                            <h6 class="fw-bold text-primary mb-3">Report Info</h6>
                            <p><strong>ID:</strong> {{ report.id }}</p>
                            <p><strong>Created:</strong> {{ report.date_created|date:"M d, Y" }}</p>
                            <p><strong>Renter:</strong> {{ report.renter.user.get_full_name }}</p>
                            
                            {% if report.uploaded_file %}
                                <p><strong>File:</strong> <a href="{{ report.uploaded_file.url }}" target="_blank" class="text-primary">View/Download</a></p>
                            {% endif %}

                            <hr>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-primary mb-0">Rooms</h6>
                                <button type="button" class="btn btn-success btn-sm" onclick="addRoomBlockEdit({{ report.id }})">
                                    <i class="bi bi-plus"></i> Add
                                </button>
                            </div>

                            <ul class="list-group" id="editRoomList_{{ report.id }}">
                                {% for room_link in report.report_rooms.all %}
                                <li class="list-group-item list-group-item-action" onclick="showRoomEdit('{{ room_link.id }}', {{ report.id }})">
                                    {{ room_link.room.room_name }} 
                                    <span class="badge bg-primary float-end">
                                        {{ room_link.room.area_conditions.count }}
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Right Content -->
                        <div class="col-md-8 p-4">
                            <div id="editRoomContainer_{{ report.id }}">
                                {% for room_link in report.report_rooms.all %}
                                <div class="room-block-edit mb-4" id="roomBlockEdit_{{ room_link.id }}" style="{% if not forloop.first %}display:none;{% endif %}">
                                    <h5 class="text-primary fw-bold mb-3">{{ room_link.room.room_name }}</h5>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <label class="form-label fw-semibold">Room Name</label>
                                            <input type="text" name="room_name_{{ room_link.room.id }}" class="form-control" value="{{ room_link.room.room_name }}" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-semibold">Description</label>
                                            <textarea name="room_description_{{ room_link.room.id }}" class="form-control" rows="2">{{ room_link.room.description }}</textarea>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-semibold">Room Photos</label>
                                            <input type="file" name="room_photos_{{ room_link.room.id }}" class="form-control" multiple>
                                            <div class="mt-2 d-flex flex-wrap gap-2">
                                                {% for photo in room_link.room.photos.all %}
                                                <img src="{{ photo.url }}" class="img-thumbnail" style="height:80px;">
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <hr>
                                    <h6 class="fw-bold mb-3">Area Conditions</h6>
                                    {% for condition in room_link.room.area_conditions.all %}
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <input type="text" name="area_name_{{ condition.id }}" value="{{ condition.area_name }}" class="form-control" required>
                                            </div>
                                            <div class="col-md-3">
                                                <select name="status_{{ condition.id }}" class="form-select">
                                                    <option value="Clean" {% if condition.status == "Clean" %}selected{% endif %}>Clean</option>
                                                    <option value="Undamaged" {% if condition.status == "Undamaged" %}selected{% endif %}>Undamaged</option>
                                                    <option value="Working" {% if condition.status == "Working" %}selected{% endif %}>Working</option>
                                                    <option value="Damaged" {% if condition.status == "Damaged" %}selected{% endif %}>Damaged</option>
                                                    <option value="Needs Repair" {% if condition.status == "Needs Repair" %}selected{% endif %}>Needs Repair</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" name="remarks_{{ condition.id }}" value="{{ condition.remarks }}" class="form-control" placeholder="Remarks">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="file" name="photo_{{ condition.id }}" class="form-control" multiple>
                                            </div>
                                        </div>
                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                            {% for img in condition.photos.all %}
                                            <img src="{{ img.url }}" class="img-thumbnail" style="height:70px;">
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}

                                <!-- Container for newly added rooms -->
                                <div id="newRoomsContainer_{{ report.id }}"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}


<!-- JavaScript (minimized but working perfectly) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let roomIndex = 0, roomCounter = 1;

    function addRoomBlock() {
        if (document.querySelector('#roomsContainer > .text-center')) {
            document.getElementById('roomsContainer').innerHTML = '';
        }
        const html = `
            <div class="card mb-4 room-card" data-index="${roomIndex}">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="text-primary fw-bold">Room ${roomCounter}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.room-card').remove(); updateSidebar();">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <input type="text" name="room_name_${roomIndex}" class="form-control" placeholder="Room Name (e.g., Master Bedroom)" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <input type="file" name="room_photos_${roomIndex}[]" class="form-control" multiple accept="image/*">
                        </div>
                        <div class="col-12">
                            <textarea name="room_description_${roomIndex}" class="form-control" rows="2" placeholder="Description (optional)"></textarea>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h6 class="fw-bold">Area Conditions</h6>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition(${roomIndex})">+ Add</button>
                    </div>
                    <div class="conditions" id="conditions_${roomIndex}"></div>
                </div>
            </div>`;
        document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', html);
        addCondition(roomIndex);
        updateSidebar();
        roomIndex++; roomCounter++;
    }

    function addCondition(idx) {
        const container = document.getElementById(`conditions_${idx}`);
        const count = container.children.length;
        const row = `
            <div class="row g-3 mb-3 align-items-end border-bottom pb-3">
                <div class="col-12 col-md-3">
                    <input type="text" name="area_name_${idx}_${count}" class="form-control" placeholder="Area (e.g., Walls)" required>
                </div>
                <div class="col-12 col-md-2">
                    <select name="status_${idx}_${count}" class="form-select">
                        <option value="Clean">Clean</option>
                        <option value="Undamaged">Undamaged</option>
                        <option value="Working">Working</option>
                        <option value="Damaged">Damaged</option>
                        <option value="Needs Repair">Needs Repair</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <input type="file" name="area_photos_${idx}_${count}[]" class="form-control" multiple accept="image/*">
                </div>
                <div class="col-12 col-md-3">
                    <input type="text" name="remarks_${idx}_${count}" class="form-control" placeholder="Remarks">
                </div>
                <div class="col-12 col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('div.row').remove()">Close</button>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', row);
    }

    function updateSidebar() {
        const list = document.getElementById('roomListSidebar');
        list.innerHTML = '';
        document.querySelectorAll('.room-card').forEach((card, i) => {
            const name = card.querySelector('input[name*="room_name"]').value || `Room ${i+1}`;
            const li = `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${name}</span>
                <span class="badge bg-primary rounded-pill">${card.querySelectorAll('.row.border-bottom').length}</span>
            </li>`;
            list.insertAdjacentHTML('beforeend', li);
        });
        if (!list.hasChildNodes()) list.innerHTML = '<li class="list-group-item text-muted text-center">No rooms</li>';
    }

    // Search
    document.getElementById('searchInput')?.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#reportTableBody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    // Auto-update sidebar on room name change
    document.addEventListener('input', e => {
        if (e.target.name && e.target.name.includes('room_name')) updateSidebar();
    });
</script>

<script>
function showRoomEdit(roomId, reportId) {
    document.querySelectorAll(`#editRoomContainer_${reportId} > .room-block-edit`).forEach(el => {
        el.style.display = 'none';
    });
    document.getElementById(`roomBlockEdit_${roomId}`).style.display = 'block';
}

// Add new room sa edit modal
function addRoomBlockEdit(reportId) {
    const container = document.getElementById(`newRoomsContainer_${reportId}`);
    const index = container.children.length;
    const html = `
        <div class="card p-4 mb-4 border-primary">
            <h5 class="text-primary">New Room</h5>
            <div class="row g-3">
                <div class="col-12"><input type="text" name="new_room_name_${index}" class="form-control" placeholder="Room Name" required></div>
                <div class="col-12"><textarea name="new_room_desc_${index}" class="form-control" placeholder="Description"></textarea></div>
                <div class="col-12"><input type="file" name="new_room_photos_${index}[]" class="form-control" multiple></div>
            </div>
            <hr>
            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addConditionNew(${index})">+ Add Area Condition</button>
            <div id="newConditions_${index}"></div>
        </div>`;
    container.insertAdjacentHTML('beforeend', html);
}

let newCondIndex = 0;
function addConditionNew(roomIdx) {
    const container = document.getElementById(`newConditions_${roomIdx}`);
    const html = `
        <div class="border rounded p-3 mb-3 bg-light">
            <div class="row g-3">
                <div class="col-md-4"><input type="text" name="new_area_name_${roomIdx}_${newCondIndex}" class="form-control" placeholder="Area Name" required></div>
                <div class="col-md-4"><input type="text" name="new_remarks_${roomIdx}_${newCondIndex}" class="form-control" placeholder="Remarks"></div>
                <div class="col-md-4"><input type="file" name="new_area_photos_${roomIdx}_${newCondIndex}[]" class="form-control" multiple></div>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', html);
    newCondIndex++;
}
</script>
</body>
</html>
{% endblock %}