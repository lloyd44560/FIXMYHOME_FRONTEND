{% extends "baseAgent.html" %}
{% load widget_tweaks %}

{% block content %}
<!-- Top Navigation -->
{% include 'components/home/navigatorBaseAgent.html' %}

<div class="max-w-2xl mx-auto mt-10 bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full">
  <h2 class="text-3xl font-bold text-center text-[#293272] mb-8">
    {% if form.instance.pk %}Edit Property{% else %}Create Property{% endif %}
  </h2>

  <form method="POST" class="space-y-6" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="gap-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Property Name</label>
        {{ form.name|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
        <label class="block text-sm font-medium text-gray-700 mb-1 mt-4">Property ID</label>
        {{ form.property_id|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Street</label>
            {{ form.street|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">House Number</label>
            {{ form.house_number|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
          </div>
        </div>
        <label class="block text-sm font-medium text-gray-700 mb-1 mt-4">Address</label>
        {{ form.address|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
        <label class="block text-sm font-medium text-gray-700 mb-1 mt-4">Key Number</label>
        {{ form.key_number|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Renter Name</label>
        {{ form.renter_name|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
        {% if form.renter_name.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.renter_name.errors.0 }}</p>
        {% endif %}
      </div>
         <div class="flex sm:justify-start justify-end">
            <a href="{% if form.instance.id %}{% url 'renter_invitation' %}?name={{ form.renter_name.value|urlencode }}
              &email={{ form.renter_contact.value|urlencode }}&property_id={{ form.instance.id|urlencode }}&property_name={{ form.name.value|urlencode }}
              &property_address={{ form.address.value|urlencode }}&property_lease_start={{ form.lease_start.value|date:'m/d/Y'|urlencode }}
              &property_lease_end={{ form.lease_end.value|date:'m/d/Y'|urlencode }}&property_rent={{ form.rent.value|urlencode }}
              &property_status={{ form.status.value|urlencode }}{% else %}#{% endif %}"
              class="bg-[#EF7153] hover:bg-[#d35032] text-white px-4 py-2 rounded-lg text-sm transition shadow 
              {% if not form.renter_name.value or not form.renter_contact.value or not form.instance.id %}opacity-50 pointer-events-none{% endif %}">
              Send Invitation
            </a>
        </div>
    </div>
    {% if request.user.is_authenticated and request.user.agentregister.is_admin %}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Property Manager</label>
        {{ form.property_manager|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
      </div>
    </div>
    {% endif %}

    <div x-data="{ imageUrl: '', showZoom: false }"
      {% if form.instance.property_photo %}
        x-init="imageUrl='{{ form.instance.property_photo.url|escapejs }}'"
      {% endif %}>
      <label class="block text-sm font-medium text-gray-700 mb-1 mt-4">Upload Photo</label>

      <!-- Modern Upload Box -->
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 transition">
          <input type="file" name="property_photo" id="id_property_photo"
                @change="
                    const file = $event.target.files[0];
                    if(file) imageUrl = URL.createObjectURL(file);
                "
                class="hidden">
          <label for="id_property_photo" class="cursor-pointer text-[#293272] font-medium hover:underline">
              Click to upload or replace image
          </label>
      </div>

      <!-- Image Preview -->
      <template x-if="imageUrl">
          <div class="mt-4">
            <img :src="imageUrl" @click="showZoom = true"
                class="w-full max-h-[5rem] object-cover rounded-lg shadow cursor-zoom-in hover:opacity-90 transition" />
          </div>
      </template>

      <!-- Zoom Modal -->
      <div x-show="showZoom" x-transition
          class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"
          @click="showZoom = false">
          <img :src="imageUrl" class="max-w-full max-h-full rounded-lg shadow-lg cursor-zoom-out">
      </div>
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Renter Contact</label>
      {{ form.renter_contact|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Lease Start</label>
        {{ form.lease_start|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Lease End</label>
        {{ form.lease_end|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Rent</label>
        {{ form.rent|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        {{ form.status|add_class:"w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" }}
      </div>
    </div>

    <div class="mt-6 flex flex-col space-y-3">
      <button type="submit"
        class="w-full text-center text-lg py-3 rounded-2xl bg-[#EF7153] hover:bg-[#d35032] text-white font-semibold transition-all duration-200 shadow-md hover:shadow-lg">
        Save
      </button>
      <a href="javascript:history.back()" 
        class="block text-center py-3 bg-gray-100 rounded-2xl font-semibold text-gray-700 hover:bg-gray-200">
        Cancel
      </a>
    </div>
  </form>
</div>

{% include 'components/footerAgent.html' %}
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
