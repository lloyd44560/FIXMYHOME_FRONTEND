{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Job Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-6xl mx-auto flex h-screen bg-white shadow rounded-lg overflow-hidden mt-6">

  <!-- Sidebar: Job threads -->
  <div class="w-1/3 border-r border-gray-200 overflow-y-auto bg-gray-50">
    <h2 class="text-lg font-bold p-4 border-b">Chats</h2>
    
    <!-- Filters -->
    <!-- Toggle button -->
    <div class="p-4 border-b flex justify-between items-center">
         <p class="font-bold mb-2">Filter Options</p>
      <button id="toggle-filters" class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm">Show/Hide</button>
    </div>
    
    <!-- Filters container -->
    <div id="filters-container" class="p-4 border-b">
    
      <div class="flex space-x-2 mb-4">
        <button id="filter-urgent" class="px-6 py-1 rounded-full font-medium text-white-600 border border-blue-600">Urgent</button>
        <button id="filter-nonurgent" class="px-6 py-1 rounded-full font-medium text-white-600 border border-blue-600">Non-Urgent</button>
      </div>
    
      <p class="font-bold mb-2">Sort by Time</p>
      <div class="flex space-x-2">
        <button id="sort-newest" class="px-6 py-1 rounded-full font-medium text-white-600 border border-blue-600">Newest First</button>
        <button id="sort-oldest" class="px-6 py-1 rounded-full font-medium text-white-600 border border-blue-600">Oldest First</button>
      </div>
    </div>
    
    <script>
      const toggleBtn = document.getElementById('toggle-filters');
      const filtersContainer = document.getElementById('filters-container');
    
      toggleBtn.addEventListener('click', () => {
        filtersContainer.classList.toggle('hidden'); // hide/show
      });
    </script>



    <!-- Job list -->
    <div class="job-list-container">
      {% for job_info in job_previews %}
      <button onclick="openJobChat('{{ job_info.job.job_code }}')" 
              class="w-full flex items-left px-4 py-3 hover:bg-gray-100 border-b job-item"
              data-priority="{% if job_info.job.priority == 1 %}urgent{% else %}nonurgent{% endif %}"
              data-timestamp="{% if job_info.last_timestamp %}{{ job_info.last_timestamp|date:'U' }}{% else %}0{% endif %}">
        
        <!-- Avatar -->
        <img src="{% if job_info.job.trader.user.profile_image %}
            {{ job_info.job.trader.user.profile_image.url }}
         {% else %}
            {% static 'renter/images/avatar_placeholder' %} 
         {% endif %}" />

        <!-- Chat info -->
        <div class="flex-1 overflow-hidden">
          <p class="font-medium text-gray-800 truncate">Job #{{ job_info.job.job_code }}</p>
          {% if job_info.last_message %}
          <p class="text-sm text-gray-500 truncate">{{ job_info.last_message }}</p>
          {% endif %}
        </div>

        <!-- Time -->
        {% if job_info.last_timestamp %}
        <div class="text-xs text-gray-400 ml-2 whitespace-nowrap">
          {{ job_info.last_timestamp|timesince }} ago
        </div>
        {% endif %}
      </button>
      {% empty %}
      <p class="p-4 text-gray-400">No job chats available.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Chat area -->
  <div class="flex-1 flex flex-col">
    <div id="chat-header" class="p-4 bg-gray-50 font-semibold text-gray-700 border-b">
      Select a job to start chatting
    </div>
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-2"></div>

    <form id="message-form" class="border-t flex p-3 bg-gray-50 hidden" onsubmit="sendMessage(event)">
      {% csrf_token %}
      <input id="message-input" name="message" class="flex-1 p-2 border rounded-lg focus:outline-none" placeholder="Type a message..." autocomplete="off" />
      <button type="submit" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg">Send</button>
    </form>
  </div>
</div>

<script>
  let activeJobCode = null;
  let currentPriorityFilter = null; // "urgent" or "nonurgent" or null
  let currentTimeSort = "newest"; // "newest" or "oldest"

  // Open chat
  function openJobChat(jobCode) {
    activeJobCode = jobCode;
    $("#chat-header").text("Job: " + jobCode);
    $("#message-form").removeClass("hidden");
    loadMessages();
  }

  // Load messages for a job
  function loadMessages() {
    if (!activeJobCode) return;

    const fetchURL = "{% url 'fetch_job_messages' 'JOB_CODE_PLACEHOLDER' %}".replace('JOB_CODE_PLACEHOLDER', activeJobCode);

    $.get(fetchURL, function(data) {
      const box = $("#chat-box");
      box.empty();

      // Update chat header with priority
      $("#chat-header").text("Job: " + data.job_code + " (" + data.job_priority + ")");

      data.messages.forEach(msg => {
        const alignment = msg.sender === "{{ request.user.username }}" ? "text-right" : "text-left";
        const bubbleColor = msg.sender === "{{ request.user.username }}" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-800";
        box.append(`
          <div class="${alignment}">
            <span class="inline-block px-3 py-2 rounded-lg ${bubbleColor} mb-1">
              <strong>${msg.sender}</strong><br>${msg.content}
            </span>
            <div class="text-xs text-gray-400">${msg.timestamp}</div>
          </div>
        `);
      });

      box.scrollTop(box[0].scrollHeight);
    });
  }

  // Send message
  function sendMessage(event) {
    event.preventDefault();
    if (!activeJobCode) return;

    const message = $("#message-input").val().trim();
    if (!message) return;

    const sendURL = "{% url 'send_job_message' 'JOB_CODE_PLACEHOLDER' %}".replace('JOB_CODE_PLACEHOLDER', activeJobCode);

    $.ajax({
      url: sendURL,
      method: "POST",
      headers: {'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()},
      data: JSON.stringify({ message }),
      contentType: "application/json",
      success: function() {
        $("#message-input").val("");
        loadMessages();
      },
      error: function(err) {
        console.error("Message send failed", err);
      }
    });
  }

  // Highlight filter buttons
    // Highlight filter buttons consistently
    function updateFilterButtons() {
        // Reset all filter buttons
        $("#filter-urgent, #filter-nonurgent, #sort-newest, #sort-oldest")
            .removeClass("bg-blue-600 text-white border-blue-600")
            .addClass("bg-white text-white-600 border border-blue-600");
    
        // Highlight priority filters
        if(currentPriorityFilter === "urgent") $("#filter-urgent").addClass("bg-blue-600 text-white");
        if(currentPriorityFilter === "nonurgent") $("#filter-nonurgent").addClass("bg-blue-600 text-white");
    
        // Highlight time sort buttons
        if(currentTimeSort === "newest") $("#sort-newest").addClass("bg-blue-600 text-white");
        if(currentTimeSort === "oldest") $("#sort-oldest").addClass("bg-blue-600 text-white");
    }


  // Filter and sort jobs
  function filterJobList() {
    $(".job-item").each(function() {
      const priority = $(this).data("priority"); // "urgent" or "nonurgent"
      $(this).toggle(currentPriorityFilter ? priority === currentPriorityFilter : true);
    });

    // Sort by timestamp
    const jobsContainer = $(".job-list-container");
    const jobs = $(".job-item").get();
    jobs.sort((a, b) => {
      const t1 = $(a).data("timestamp");
      const t2 = $(b).data("timestamp");
      return currentTimeSort === "newest" ? t2 - t1 : t1 - t2;
    });
    $.each(jobs, (idx, itm) => jobsContainer.append(itm));
  }

  // Filter button clicks
  $("#filter-urgent").click(function() {
    currentPriorityFilter = (currentPriorityFilter === "urgent") ? null : "urgent";
    updateFilterButtons();
    filterJobList();
  });
  $("#filter-nonurgent").click(function() {
    currentPriorityFilter = (currentPriorityFilter === "nonurgent") ? null : "nonurgent";
    updateFilterButtons();
    filterJobList();
  });

  // Time sort button clicks
  $("#sort-newest").click(function() { currentTimeSort = "newest"; updateFilterButtons(); filterJobList(); });
  $("#sort-oldest").click(function() { currentTimeSort = "oldest"; updateFilterButtons(); filterJobList(); });

  // Initialize filters
  updateFilterButtons();
  setInterval(loadMessages, 3000);
</script>

</body>
</html>
