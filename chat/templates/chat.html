{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ room_user.username }}</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
<div class="flex h-screen">

  <!-- Sidebar -->
  <div class="w-72 bg-gray-900 text-white flex flex-col">
    <h2 class="p-4 font-bold text-xl border-b border-gray-700">Chats</h2>
    <div class="flex-1 overflow-y-auto">
      {% for item in user_last_messages %}
      <a href="{% url 'chat' item.slug %}" 
         class="block px-4 py-3 border-b border-gray-800 hover:bg-gray-700 transition 
                {% if item.user.username == room_user.username %}bg-gray-700 font-semibold{% endif %}">
          <div class="flex justify-between items-center">
            <span>{{ item.user.username }}</span>
            {% if item.last_message %}
              <span class="text-xs text-gray-400">{{ item.last_message.timestamp|date:"H:i" }}</span>
            {% endif %}
          </div>
          {% if item.last_message %}
            <div class="text-sm text-gray-400 truncate">{{ item.last_message.content|truncatewords:5 }}</div>
          {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col">
    
    <!-- Chat Header -->
    <div class="p-4 bg-white border-b flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
        <div>
          <h3 class="font-semibold text-lg">{{ room_user.username }}</h3>
          <p class="text-xs text-gray-500">Active now</p>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="flex-1 p-4 overflow-y-auto bg-gray-50" id="chatbox">
      {% for message in chats %}
      <div class="mb-4 {% if message.sender == request.user %}text-right{% else %}text-left{% endif %}">
        <div class="inline-block px-4 py-2 rounded-2xl shadow 
          {% if message.sender == request.user %}
            bg-blue-500 text-white rounded-br-none
          {% else %}
            bg-gray-200 text-gray-800 rounded-bl-none
          {% endif %}">
          {{ message.content }}
        </div>
        <div class="text-xs text-gray-400 mt-1">
          {{ message.timestamp|date:"H:i" }}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white border-t flex items-center gap-2">
      <input type="text" id="my_input" placeholder="Type a message..." 
             class="flex-1 px-4 py-2 border rounded-full focus:ring focus:ring-blue-300">
      <button id="submit_button" 
              class="px-5 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full font-medium">
        Send
      </button>
    </div>
  </div>

</div>

<!-- Script -->
<script>
$(document).ready(function() {
    const roomSlug = "{{ room_slug }}";

    function fetchMessages() {
        $.ajax({
            url: "{% url 'fetch_messages' room_slug %}",
            type: "GET",
            success: function(data) {
                const chatbox = $("#chatbox");
                chatbox.empty();
                data.messages.forEach(msg => {
                    const align = msg.sender === "{{ request.user.username }}" ? "text-right" : "text-left";
                    const bubble = msg.sender === "{{ request.user.username }}"
                      ? "bg-blue-500 text-white rounded-br-none"
                      : "bg-gray-200 text-gray-800 rounded-bl-none";

                    chatbox.append(`
                      <div class="mb-4 ${align}">
                        <div class="inline-block px-4 py-2 rounded-2xl shadow ${bubble}">
                          ${msg.content}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${msg.timestamp}</div>
                      </div>
                    `);
                });
                chatbox.scrollTop(chatbox[0].scrollHeight);
            }
        });
    }

    $("#submit_button").click(function() {
        const msg = $("#my_input").val().trim();
        if (!msg) return;

        $.ajax({
            url: "{% url 'send_message' room_slug %}",
            type: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data: JSON.stringify({message: msg}),
            contentType: "application/json",
            success: function() {
                $("#my_input").val("");
                fetchMessages();
            }
        });
    });

    $("#my_input").keypress(function(e){
        if(e.which == 13){
            $("#submit_button").click();
            return false;
        }
    });

    setInterval(fetchMessages, 3000);
    fetchMessages();
});
</script>
</body>
</html>
